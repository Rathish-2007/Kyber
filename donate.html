<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Donation</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Donate to Campaign</h1>
        </div>
        
        <div class="form-container" id="donation-form-container">
            <div class="form-group">
                <label for="name">Your Name</label>
                <input type="text" id="name" name="name" required placeholder="Enter your full name">
            </div>
            
            <div class="form-group">
                <label for="email">Your Email</label>
                <input type="email" id="email" name="email" required placeholder="Enter your email address">
            </div>
            
            <div class="form-group">
                <label for="amount">Donation Amount (USD)</label>
                <input type="number" id="amount" name="amount" min="1" required placeholder="Enter amount">
            </div>
            
            <div class="wallet-section">
                <label for="wallet-address">MetaMask Wallet Address (for Reward)</label>
                <input type="text" class="wallet-address" id="wallet-address" placeholder="Connect your wallet to receive ETH reward">
                <button class="connect-btn" id="connect-metamask">Connect MetaMask</button>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="is_anonymous" name="is_anonymous" style="width: auto; margin-right: 10px;">
                    Donate Anonymously
                </label>
            </div>
            
            <button class="donate-btn" id="donate-btn">Donate</button>
        </div>
        
        <div class="thank-you" id="thank-you" style="display:none;">
            <div class="success-icon">âœ“</div>
            <h2>Thank you for your donation!</h2>
            <p>Your contribution helps us make a difference. Your ETH reward has been sent to your wallet.</p>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const connectBtn = document.getElementById('connect-metamask');
            const donateBtn = document.getElementById('donate-btn');
            const walletAddressInput = document.getElementById('wallet-address');
            const donationForm = document.getElementById('donation-form-container');
            const thankYou = document.getElementById('thank-you');
            const urlParams = new URLSearchParams(window.location.search);
            const campaignId = urlParams.get('campaign_id');
            const user = getLoggedInUser();

            if (user) {
                document.getElementById('name').value = `${user.first_name || ''} ${user.last_name || ''}`;
                document.getElementById('email').value = user.email || '';
            }

            // Connect to MetaMask just to get the user's address for the reward
            connectBtn.addEventListener('click', async function() {
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        walletAddressInput.value = accounts[0];
                        connectBtn.textContent = 'Wallet Connected';
                        connectBtn.disabled = true;
                    } catch (err) {
                        alert('MetaMask connection failed: ' + err.message);
                    }
                } else {
                    alert('MetaMask is not installed. Please install it to receive your reward.');
                }
            });

            // Handle the donation submission to your backend
            donateBtn.addEventListener('click', async function() {
                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const amount = document.getElementById('amount').value;
                const wallet = walletAddressInput.value;

                if (!name || !email || !amount) {
                    alert('Please fill in your name, email, and donation amount.');
                    return;
                }
                if (!wallet) {
                    alert('Please connect your MetaMask wallet to be eligible for a reward.');
                    return;
                }
                
                const donationData = {
                    campaign_id: campaignId,
                    name: name,
                    email: email,
                    amount: amount,
                    wallet: wallet, // The user's address for the reward
                    is_anonymous: document.getElementById('is_anonymous').checked,
                    user_id: user ? user.user_id : null
                };

                try {
                    donateBtn.textContent = 'Processing...';
                    donateBtn.disabled = true;

                    // Use your ORIGINAL donation endpoint. No crypto transaction happens on the frontend.
                    const result = await apiRequest('/api/donate', {
                        method: 'POST',
                        body: JSON.stringify(donationData)
                    });

                    if (result.success) {
                        donationForm.style.display = 'none';
                        thankYou.style.display = 'block';
                    } else {
                        alert(result.error || 'Donation failed. Please try again.');
                    }
                } catch (err) {
                    alert('An error occurred while submitting your donation.');
                    console.error('Donation error:', err);
                } finally {
                    donateBtn.textContent = 'Donate';
                    donateBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>